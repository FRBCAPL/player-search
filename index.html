<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Player Search Portal</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
  #searchSection { display: block; }
  input, button { padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; }
  button { background: #1976d2; color: white; border: none; cursor: pointer; border-radius: 4px; }
  #results { margin-top: 20px; }
  #pinSection { margin-bottom: 30px; }
  
  /* New CSS Additions */
  #searchInput {
    font-size: 16px;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 4px;
  }
  
  .player {
    background: #f9f9f9;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .player h3 {
    margin: 0 0 8px 0;
    color: #1976d2;
  }
  
  .player p {
    margin: 5px 0;
  }
</style>
</head>
<body>

<!-- PIN Entry Section -->
<div id="pinSection">
  <h2>Player Search Portal</h2>
  <input type="password" id="pinInput" placeholder="Enter your PIN" />
  <button onclick="verifyPin()">Submit</button>
  <div id="pinMessage" style="color:red; margin-top:10px;"></div>
</div>

<!-- Search Interface Section -->
<div id="searchSection" style="display:none;">
  <h2>Player Search</h2>
  <input type="text" id="searchInput" placeholder="Search players or availability..." />
  <div id="results"><p>Start typing to search players...</p></div>
</div>

<script>
const sheetID = "1tvMgMHsRwQxsR6lMNlSnztmwpK7fhZeNEyqjTqmRFRc";
const pinSheetName = "BCAPL SIGNUP";
const playerSheetName = "BCAPL Availability"; // Make sure this matches your tab name
const contactSheetName = "Contact Info";

let allPlayers = [];

// 1. Verify PIN against column L in "BCAPL SIGNUP"
async function verifyPin() {
  const pin = document.getElementById("pinInput").value.trim();
  if (!pin) {
    document.getElementById("pinMessage").innerText = "Please enter a PIN.";
    return;
  }
  document.getElementById("pinMessage").innerText = "Checking PIN...";

  try {
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(pinSheetName)}`;
    const response = await fetch(url);
    const text = await response.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    const rows = json.table.rows;
    const pinExists = rows.some(row => {
      const cell = row.c[11]; // column L (index 11)
      return cell && cell.v && cell.v.toString() === pin;
    });

    if (pinExists) {
      document.getElementById("pinSection").style.display = "none";
      document.getElementById("searchSection").style.display = "block";
      initSearch();
    } else {
      document.getElementById("pinMessage").innerText = "Invalid PIN. Please try again.";
    }
  } catch (error) {
    console.error("Error verifying PIN:", error);
    document.getElementById("pinMessage").innerText = "Error verifying PIN. Please try again later.";
  }
}

// Helper: fetch sheet data by tab name
async function fetchSheetData(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const response = await fetch(url);
  const text = await response.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));
  return json.table.rows;
}

// 2. Fetch players with contact info AND availability
async function fetchPlayers() {
  try {
    const [playerRows, contactRows] = await Promise.all([
      fetchSheetData(playerSheetName),
      fetchSheetData(contactSheetName)
    ]);

    // Create contact map (case-insensitive)
    const contactMap = {};
    contactRows.forEach(row => {
      const name = row.c[0]?.v?.toString().trim().toLowerCase() || "";
      const phone = row.c[1]?.v?.toString() || "";
      const email = row.c[2]?.v?.toString() || "";
      const facebook = row.c[3]?.v?.toString() || "";
      contactMap[name] = [phone, email, facebook].filter(Boolean).join(' | ');
    });

    // Include availability (B-G) and preferred location (H)
    return playerRows.map(row => ({
      name: row.c[0]?.v?.toString().trim() || "",
      contact: contactMap[row.c[0]?.v?.toString().trim().toLowerCase()] || "No contact info",
      availability: row.c.slice(1, 7).map(day => day?.v || "").filter(Boolean), // B-G = Mon-Sat
      location: row.c[7]?.v?.toString().trim() || "No preferred location" // Column H
    }));
  } catch (error) {
    console.error("Error:", error);
    return [];
  }
}



// 3. Render players with availability
function renderPlayers(list) {
  const container = document.getElementById("results");
  container.innerHTML = list.length ? list.map(player => `
    <div class="player">
      <h3>${player.name}</h3>
      <p>üìû Contact: ${player.contact}</p>
      <p>üìÖ Available: ${player.availability.join(", ")}</p>
      <p>üìç Preferred Location: ${player.location}</p>
    </div>
  `).join("") : "<p>No players found</p>";
}


// 4. Initialize search with dynamic filtering
async function initSearch() {
  allPlayers = await fetchPlayers();
  const searchInput = document.getElementById("searchInput");

  searchInput.addEventListener("input", e => {
    const term = e.target.value.toLowerCase();
    if (!term) {
      document.getElementById("results").innerHTML = "<p>Start typing to search players...</p>";
      return;
    }
    const filtered = allPlayers.filter(p => 
      p.name.toLowerCase().includes(term) || 
      p.availability.some(day => day.toLowerCase().includes(term))
    );
    renderPlayers(filtered);
  });
}
</script>
</body>
</html>
