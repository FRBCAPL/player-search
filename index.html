<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player Search Portal</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
  #searchSection { display: none; }
  input, button { width: 100%; padding: 12px; margin: 10px 0; box-sizing: border-box; }
  button { background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; }
  #results { margin-top: 20px; }
  .player { background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .player h3 { margin: 0 0 8px; color: #1976d2; }
  .player p { margin: 4px 0; }
  .availability-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 10px; }
  .availability-day { background: #f0f7ff; border: 1px solid #cce0ff; border-radius: 4px; padding: 6px; }
  .available-slot { font-size: 0.9em; margin-top: 4px; background: #e6f7d9; border-radius: 3px; padding: 4px; }
</style>
</head>
<body>

<div id="pinSection">
  <h2>Player Search Portal</h2>
  <input type="password" id="pinInput" placeholder="Enter your PIN" />
  <button onclick="verifyPin()">Submit</button>
  <div id="pinMessage" style="color:red; margin-top:10px;"></div>
</div>

<div id="searchSection">
  <h2>Player Search</h2>
  <input type="text" id="searchInput" placeholder="Search players or availability..." />
  <div id="results"><p>Start typing to search players...</p></div>
</div>

<script>
(() => {
  const CONFIG = {
    sheetID: "1tvMgMHsRwQxsR6lMNlSnztmwpK7fhZeNEyqjTqmRFRc",
    sheets: {
      pin: "BCAPL SIGNUP",
      availability: "BCAPL Availability",
      contact: "Contact Info"
    },
    columns: {
      contact: {
        name: 0,    // Column A
        phone: 1,   // Column B
        email: 2,   // Column C
        facebook: 3 // Column D
      },
      availability: {
        name: 0,    // Column A
        monday: 1,  // Column B
        tuesday: 2, // Column C
        wednesday: 3, // Column D
        thursday: 4,  // Column E
        friday: 5,    // Column F
        saturday: 6,  // Column G
        location: 7   // Column H
      }
    }
  };

  let allPlayers = [];

  async function verifyPin() {
    const pin = document.getElementById("pinInput").value.trim();
    if (!pin) {
      document.getElementById("pinMessage").innerText = "Please enter a PIN.";
      return;
    }
    document.getElementById("pinMessage").innerText = "Checking PIN...";

    try {
      const rows = await fetchSheetData(CONFIG.sheets.pin);
      const validPin = rows.some(row => 
        row.c[11]?.v?.toString() === pin // Column L
      );

      if (validPin) {
        document.getElementById("pinSection").style.display = "none";
        document.getElementById("searchSection").style.display = "block";
        initSearch();
      } else {
        document.getElementById("pinMessage").innerText = "Invalid PIN. Please try again.";
      }
    } catch (error) {
      console.error("PIN Error:", error);
      document.getElementById("pinMessage").innerText = "Error verifying PIN. Please try again later.";
    }
  }

  async function fetchSheetData(sheetName) {
    const url = `https://docs.google.com/spreadsheets/d/${CONFIG.sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
    const response = await fetch(url);
    const text = await response.text();
    return JSON.parse(text.substring(47, text.length - 2)).table.rows;
  }

  async function fetchPlayers() {
    try {
      const [availabilityRows, contactRows] = await Promise.all([
        fetchSheetData(CONFIG.sheets.availability),
        fetchSheetData(CONFIG.sheets.contact)
      ]);

      // Debug raw data
      console.log("First 3 Availability Names:", availabilityRows.slice(0,3).map(r => r.c[CONFIG.columns.availability.name]?.v));
      console.log("First 3 Contact Names:", contactRows.slice(0,3).map(r => r.c[CONFIG.columns.contact.name]?.v));

      // Build contact map
      const contactMap = {};
      contactRows.forEach(row => {
        const name = row.c[CONFIG.columns.contact.name]?.v?.toString().trim();
        if (!name) return;
        
        contactMap[name.toLowerCase()] = {
          phone: row.c[CONFIG.columns.contact.phone]?.v?.toString().replace("Text Only: ", "").trim() || "Not provided",
          email: row.c[CONFIG.columns.contact.email]?.v?.toString().replace("Email: ", "").trim() || "Not provided",
          facebook: row.c[CONFIG.columns.contact.facebook]?.v?.toString().trim() || "Not provided"
        };
      });

      // Process players with strict column mapping
      return availabilityRows.map(row => {
        const name = row.c[CONFIG.columns.availability.name]?.v?.toString().trim() || "Unknown Player";
        
        return {
          name: name,
          contact: contactMap[name.toLowerCase()] || {
            phone: "Not found",
            email: "Not found",
            facebook: "Not found"
          },
          availability: {
            Mon: row.c[CONFIG.columns.availability.monday]?.v?.toString().trim() || "‚ùå Unavailable",
            Tue: row.c[CONFIG.columns.availability.tuesday]?.v?.toString().trim() || "‚ùå Unavailable",
            Wed: row.c[CONFIG.columns.availability.wednesday]?.v?.toString().trim() || "‚ùå Unavailable",
            Thu: row.c[CONFIG.columns.availability.thursday]?.v?.toString().trim() || "‚ùå Unavailable",
            Fri: row.c[CONFIG.columns.availability.friday]?.v?.toString().trim() || "‚ùå Unavailable",
            Sat: row.c[CONFIG.columns.availability.saturday]?.v?.toString().trim() || "‚ùå Unavailable"
          },
          location: row.c[CONFIG.columns.availability.location]?.v?.toString().trim() || "No location specified"
        };
      }).filter(p => p.name !== "Unknown Player");
    } catch (error) {
      console.error("Data Error:", error);
      return [];
    }
  }

  function renderPlayers(players) {
    const container = document.getElementById("results");
    container.innerHTML = players.length ? players.map(player => `
      <div class="player">
        <h3>${player.name}</h3>
        <p>üìû Phone: ${player.contact.phone}</p>
        <p>üìß Email: ${player.contact.email}</p>
        <p>üîµ Facebook: ${player.contact.facebook}</p>
        <p>üìç Location: ${player.location.replace(/\n/g, "<br>")}</p>
        <div class="availability-grid">
          ${Object.entries(player.availability).map(([day, time]) => `
            <div class="availability-day">
              <strong>${day}</strong>
              <div class="available-slot">${time}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('') : '<p>No players found</p>';
  }

  async function initSearch() {
    allPlayers = await fetchPlayers();
    console.log("Processed Players:", allPlayers);
    
    document.getElementById("searchInput").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allPlayers.filter(player =>
        player.name.toLowerCase().includes(term) ||
        Object.values(player.availability).some(time => time.toLowerCase().includes(term)) ||
        player.location.toLowerCase().includes(term)
      );
      renderPlayers(filtered);
    });
  }

  window.verifyPin = verifyPin;
})();
</script>
</body>
</html>
