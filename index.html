<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Search Portal</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
  #searchSection { display: none; }
  input, button { padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; }
  button { background: #1976d2; color: white; border: none; cursor: pointer; border-radius: 4px; }
  #results { margin-top: 20px; }
  #pinSection { margin-bottom: 30px; }
  .player { background: none; border-radius: 8px; padding: 0; margin: 10px 0; box-shadow: none; }
  .player a { color: #1976d2; text-decoration: underline; font-size: 1.15em; cursor: pointer; }
  .availability-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; margin-top: 10px; }
  .availability-day { padding: 8px; border-radius: 4px; background: #f0f7ff; border: 1px solid #d0e3ff; }
  .available-slot { margin-top: 5px; padding: 4px; background: #e6f7d9; border-radius: 3px; font-size: 0.9em; }
  /* Modal Styles */
  #playerModal { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center; }
  #modalContent { background:#fff; padding:30px 20px; border-radius:10px; max-width:400px; width:90%; margin:auto; position:relative; }
  #modalContent button { position:absolute; top:8px; right:12px; background:none; border:none; font-size:1.5em; color: #1976d2; cursor:pointer; width:auto; }
  #modalBody h3 { color:#1976d2; margin-top:0; }
</style>
</head>
<body>

<div id="pinSection">
  <h2>Player Search Portal</h2>
  <input type="password" id="pinInput" placeholder="Enter your PIN" />
  <button onclick="verifyPin()">Submit</button>
  <div id="pinMessage" style="color:red; margin-top:10px;"></div>
</div>

<div id="searchSection">
  <h2>Player Search</h2>
  <input type="text" id="searchInput" placeholder="Search players or availability..." />
  <div id="results"><p>Start typing to search players...</p></div>
</div>

<!-- Player Details Modal -->
<div id="playerModal">
  <div id="modalContent">
    <button onclick="closeModal()">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const sheetID = "1tvMgMHsRwQxsR6lMNlSnztmwpK7fhZeNEyqjTqmRFRc";
const pinSheetName = "BCAPL SIGNUP";
const playerSheetName = "BCAPL Singles Availability";
const contactSheetName = "Contact Info";

let allPlayers = [];

async function verifyPin() {
  const pin = document.getElementById("pinInput").value.trim();
  if (!pin) {
    document.getElementById("pinMessage").innerText = "Please enter a PIN.";
    return;
  }
  document.getElementById("pinMessage").innerText = "Checking PIN...";

  try {
    const rows = await fetchSheetData(pinSheetName);
    const pinExists = rows.some(row => {
      const pinCol = row.c[11];
      return pinCol?.v?.toString() === pin;
    });

    if (pinExists) {
      document.getElementById("pinSection").style.display = "none";
      document.getElementById("searchSection").style.display = "block";
      initSearch();
    } else {
      document.getElementById("pinMessage").innerText = "Invalid PIN.";
    }
  } catch (error) {
    console.error("PIN Error:", error);
    document.getElementById("pinMessage").innerText = "Error verifying PIN.";
  }
}

async function fetchSheetData(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const response = await fetch(url);
  const text = await response.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));
  return json.table.rows;
}

async function fetchPlayers() {
  try {
    const [playerRows, contactRows] = await Promise.all([
      fetchSheetData(playerSheetName),
      fetchSheetData(contactSheetName)
    ]);

    // Build contact map
    const contactMap = {};
    contactRows.forEach(row => {
      const rawName = (row.c[0]?.v?.toString() || "").trim();
      if (rawName) {
        contactMap[rawName.toLowerCase()] = {
          phone: row.c[1]?.v?.toString().replace('Text or Call: ', '') || "Not provided",
          email: row.c[2]?.v?.toString().replace('Email: ', '') || "Not provided",
          facebook: row.c[3]?.v?.toString() || "Not provided",
          schedulingHub: row.c[4]?.v?.toString() || "" // Column E: Player Scheduling Hub
        };
      }
    });

    // Process players with CORRECT COLUMN MAPPING
    const processedPlayers = playerRows.map(row => {
      const rawName = (row.c[0]?.v?.toString() || "").trim();
      if (!rawName) return null;

      return {
        name: rawName,
        contact: contactMap[rawName.toLowerCase()] || {
          phone: "Not found",
          email: "Not found",
          facebook: "Not found",
          schedulingHub: ""
        },
        availability: {
          Mon: row.c[1]?.v?.toString().trim() || "‚ùå Unavailable",
          Tue: row.c[2]?.v?.toString().trim() || "‚ùå Unavailable",
          Wed: row.c[3]?.v?.toString().trim() || "‚ùå Unavailable",
          Thu: row.c[4]?.v?.toString().trim() || "‚ùå Unavailable",
          Fri: row.c[5]?.v?.toString().trim() || "‚ùå Unavailable",
          Sat: row.c[6]?.v?.toString().trim() || "‚ùå Unavailable"
        },
        location: (row.c[7]?.v?.toString() || "").trim()
      };
    }).filter(Boolean);

    return processedPlayers;
  } catch (error) {
    console.error("Error:", error);
    return [];
  }
}

function renderPlayers(players, term = "") {
  const container = document.getElementById("results");
  if (!players.length) {
    container.innerHTML = "<p>No players found</p>";
    return;
  }
  container.innerHTML = players.map((p, idx) => `
    <div class="player">
      <a href="#" onclick="showPlayerDetails(${idx}); return false;">
        ${highlight(p.name, term)}
      </a>
    </div>
  `).join("");
}

// Show player details in modal
function showPlayerDetails(idx) {
  const p = allPlayers[idx];
  if (!p) return;
  document.getElementById("modalBody").innerHTML = `
    <h3>${p.name}</h3>
    <p>üìû ${p.contact.phone}</p>
    <p>üìß ${p.contact.email}</p>
    <p>üîµ ${p.contact.facebook}</p>
    ${p.contact.schedulingHub ? `<p>üìÖ <a href="https://frusapl.com/scheduling-hub" target="_blank">Player Scheduling Hub</a></p>` : ""}
    <p><center><strong>Preferred Locations:</strong></center>
    ${p.location.replace(/\n/g, "<br>")}</p>
    <div class="availability-grid" style="margin-top:10px;">
      ${["Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(day => `
        <div class="availability-day">
          <strong>${day}</strong>
          <div class="available-slot">${p.availability[day]}</div>
        </div>
      `).join('')}
    </div>
  `;
  document.getElementById("playerModal").style.display = "flex";
}


function closeModal() {
  document.getElementById("playerModal").style.display = "none";
}

function highlight(text, term) {
  if (!term) return text;
  const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
  return text.replace(regex, match => `<span style="background:yellow">${match}</span>`);
}

async function initSearch() {
  allPlayers = await fetchPlayers();
  
  document.getElementById("searchInput").addEventListener("input", e => {
    const term = e.target.value.toLowerCase().trim();
    
    if (term.length < 3) {
      document.getElementById("results").innerHTML = 
        '<p style="color:#666">Type at least 3 letters to search</p>';
      return;
    }

    const filtered = allPlayers.filter(p => 
      p.name.toLowerCase().includes(term) || 
      Object.values(p.availability).some(v => v.toLowerCase().includes(term)) ||
      p.location.toLowerCase().includes(term)
    );
    
    renderPlayers(filtered, term); // Pass term to highlight
  });
}

function toProperCase(name) {
  if (!name) return "";
  return name
    .toLowerCase()
    .split(' ')
    .filter(Boolean)
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}
</script>
</body>
</html>
