<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Search Portal</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
  #searchSection { display: none; }
  input, button { padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; }
  button { background: #1976d2; color: white; border: none; cursor: pointer; border-radius: 4px; }
  #results { margin-top: 20px; }
  #pinSection { margin-bottom: 30px; }
  .player { background: #f9f9f9; border-radius: 8px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .player h3 { margin: 0 0 8px 0; color: #1976d2; }
  .player p { margin: 5px 0; }
  .availability-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; margin-top: 10px; }
  .availability-day { padding: 8px; border-radius: 4px; background: #f0f7ff; border: 1px solid #d0e3ff; }
  .available-slot { margin-top: 5px; padding: 4px; background: #e6f7d9; border-radius: 3px; font-size: 0.9em; }
</style>
</head>
<body>

<div id="pinSection">
  <h2>Player Search Portal</h2>
  <input type="password" id="pinInput" placeholder="Enter your PIN" />
  <button onclick="verifyPin()">Submit</button>
  <div id="pinMessage" style="color:red; margin-top:10px;"></div>
</div>

<div id="searchSection">
  <h2>Player Search</h2>
  <input type="text" id="searchInput" placeholder="Search players or availability..." />
  <div id="results"><p>Start typing to search players...</p></div>
</div>

<script>
const sheetID = "1tvMgMHsRwQxsR6lMNlSnztmwpK7fhZeNEyqjTqmRFRc";
const pinSheetName = "BCAPL SIGNUP";
const playerSheetName = "BCAPL Availability";
const contactSheetName = "Contact Info";

let allPlayers = [];

async function verifyPin() {
  const pin = document.getElementById("pinInput").value.trim();
  if (!pin) {
    document.getElementById("pinMessage").innerText = "Please enter a PIN.";
    return;
  }
  document.getElementById("pinMessage").innerText = "Checking PIN...";

  try {
    const rows = await fetchSheetData(pinSheetName);
    const pinExists = rows.some(row => {
      const pinCol = row.c[11]; // Column L (index 11)
      return pinCol && pinCol.v && pinCol.v.toString() === pin;
    });

    if (pinExists) {
      document.getElementById("pinSection").style.display = "none";
      document.getElementById("searchSection").style.display = "block";
      initSearch();
    } else {
      document.getElementById("pinMessage").innerText = "Invalid PIN. Please try again.";
    }
  } catch (error) {
    console.error("Error:", error);
    document.getElementById("pinMessage").innerText = "Error verifying PIN. Please try again later.";
  }
}

async function fetchSheetData(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const response = await fetch(url);
  const text = await response.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));
  return json.table.rows;
}

async function fetchPlayers() {
  try {
    const [playerRows, contactRows] = await Promise.all([
      fetchSheetData(playerSheetName),
      fetchSheetData(contactSheetName)
    ]);

    // Build contact map with original name preservation
    const contactMap = {};
    contactRows.forEach(row => {
      const originalName = row.c[0]?.v?.toString().trim() || "";
      const normalizedName = originalName.toLowerCase();
      contactMap[normalizedName] = {
        originalName: originalName, // Preserve original casing
        phone: row.c[1]?.v?.toString().replace('Text or Call: ', '') || "Not provided",
        email: row.c[2]?.v?.toString().replace('Email: ', '') || "Not provided",
        facebook: row.c[3]?.v?.toString() || "Not provided"
      };
    });

    // Process players with strict name preservation
    const processedPlayers = playerRows.map(row => {
      const rawName = row.c[0]?.v?.toString().trim() || "";
      const normalizedName = rawName.toLowerCase();
      
      return {
        name: rawName, // Always use original name from Availability sheet
        contact: contactMap[normalizedName] || {
          phone: "Not found",
          email: "Not found",
          facebook: "Not found"
        },
        availability: parseAvailability(row.c[7]?.v?.toString() || ""),
        location: row.c[8]?.v?.toString().trim() || "No preferred location"
      };
    }).filter(p => p.name); // Remove empty names

    console.log("Name Debug:", processedPlayers.slice(0,3).map(p => p.name));
    return processedPlayers;
  } catch (error) {
    console.error("Error:", error);
    return [];
  }
}

function parseAvailability(availabilityText) {
  const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
  const result = {};
  days.forEach(day => result[day] = "‚ùå Unavailable");

  availabilityText.split("Day:").forEach(dayBlock => {
    if (!dayBlock.trim()) return;
    
    const dayMatch = dayBlock.match(/Monday|Tuesday|Wednesday|Thursday|Friday|Saturday/i);
    const fromMatch = dayBlock.match(/From: ([0-9a-z:]+)/i);
    const toMatch = dayBlock.match(/Until: ([0-9a-z: ]+)/i);
    
    if (dayMatch && fromMatch && toMatch) {
      const shortDay = dayMatch[0].substring(0, 3);
      const timeSlot = `${fromMatch[1].trim()} - ${toMatch[1].trim()}`;
      result[shortDay] = result[shortDay] === "‚ùå Unavailable" 
        ? timeSlot 
        : `${result[shortDay]}<br>${timeSlot}`;
    }
  });

  return result;
}

function renderPlayers(list) {
  const container = document.getElementById("results");
  container.innerHTML = list.length ? list.map(player => `
    <div class="player">
      <h3>${player.name}</h3>
      <p>üìû Phone: ${player.contact.phone}</p>
      <p>üìß Email: ${player.contact.email}</p>
      <p>üîµ Facebook: ${player.contact.facebook}</p>
      <p>üìç Location: ${player.location.split('\n').map(loc => loc.trim()).join('<br>')}</p>
      <div class="availability-grid">
        ${["Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(day => `
          <div class="availability-day">
            <strong>${day}</strong>
            <div class="available-slot">${player.availability[day]}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `).join("") : "<p>No players found</p>";
}

async function initSearch() {
  allPlayers = await fetchPlayers();
  console.log("Loaded Players:", allPlayers);
  
  const searchInput = document.getElementById("searchInput");
  searchInput.addEventListener("input", e => {
    const term = e.target.value.toLowerCase();
    const filtered = allPlayers.filter(p => 
      p.name.toLowerCase().includes(term) || 
      Object.values(p.availability).some(time => time.toLowerCase().includes(term)) ||
      p.location.toLowerCase().includes(term)
    );
    renderPlayers(filtered);
  });
}
</script>
</body>
</html>
