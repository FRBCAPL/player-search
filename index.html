<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Player Search Portal</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 0 10px; }
  #searchSection { display: none; }
  input, button { width: 100%; padding: 12px; margin: 10px 0; box-sizing: border-box; }
  button { background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; }
  #results { margin-top: 20px; }
  .player { background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .player h3 { margin: 0 0 8px; color: #1976d2; }
  .player p { margin: 4px 0; }
  .availability-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 10px; }
  .availability-day { background: #f0f7ff; border: 1px solid #cce0ff; border-radius: 4px; padding: 6px; }
  .available-slot { font-size: 0.9em; margin-top: 4px; background: #e6f7d9; border-radius: 3px; padding: 4px; }
</style>
</head>
<body>

<div id="pinSection">
  <h2>Player Search Portal</h2>
  <input type="password" id="pinInput" placeholder="Enter your PIN" />
  <button onclick="verifyPin()">Submit</button>
  <div id="pinMessage" style="color:red; margin-top:10px;"></div>
</div>

<div id="searchSection">
  <h2>Player Search</h2>
  <input type="text" id="searchInput" placeholder="Search players or availability..." />
  <div id="results"><p>Start typing to search players...</p></div>
</div>

<script>
(() => {
  const sheetID = "1tvMgMHsRwQxsR6lMNlSnztmwpK7fhZeNEyqjTqmRFRc";
  const pinSheetName = "BCAPL SIGNUP";
  const playerSheetName = "BCAPL Availability";
  const contactSheetName = "Contact Info";

  const CONTACT_COLS = { NAME: 0, PHONE: 1, EMAIL: 2, FACEBOOK: 3 };
  const AVAILABILITY_COLS = {
    NAME: 0,
    MONDAY: 1,
    TUESDAY: 2,
    WEDNESDAY: 3,
    THURSDAY: 4,
    FRIDAY: 5,
    SATURDAY: 6,
    LOCATION: 7
  };

  let allPlayers = [];

  async function verifyPin() {
    const pin = document.getElementById("pinInput").value.trim();
    if (!pin) {
      document.getElementById("pinMessage").innerText = "Please enter a PIN.";
      return;
    }
    document.getElementById("pinMessage").innerText = "Checking PIN...";

    try {
      const rows = await fetchSheetData(pinSheetName);
      const pinExists = rows.some(row => {
        const pinCol = row.c[11];
        return pinCol && pinCol.v && pinCol.v.toString() === pin;
      });

      if (pinExists) {
        document.getElementById("pinSection").style.display = "none";
        document.getElementById("searchSection").style.display = "block";
        initSearch();
      } else {
        document.getElementById("pinMessage").innerText = "Invalid PIN. Please try again.";
      }
    } catch (e) {
      console.error(e);
      document.getElementById("pinMessage").innerText = "Error verifying PIN. Please try again later.";
    }
  }

  async function fetchSheetData(sheetName) {
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
    const response = await fetch(url);
    const text = await response.text();
    const json = JSON.parse(text.substring(47, text.length - 2));
    return json.table.rows;
  }

  async function fetchPlayers() {
    try {
      const [playerRows, contactRows] = await Promise.all([
        fetchSheetData(playerSheetName),
        fetchSheetData(contactSheetName)
      ]);

      // Build contact map keyed by normalized full name
      const contactMap = {};
      contactRows.forEach(row => {
        const name = row.c[CONTACT_COLS.NAME]?.v?.toString().trim() || "";
        if (!name) return;
        const key = name.toLowerCase();
        contactMap[key] = {
          phone: (row.c[CONTACT_COLS.PHONE]?.v?.toString() || "").replace("Text Only: ", "").trim() || "Not provided",
          email: (row.c[CONTACT_COLS.EMAIL]?.v?.toString() || "").replace("Email: ", "").trim() || "Not provided",
          facebook: (row.c[CONTACT_COLS.FACEBOOK]?.v?.toString() || "").trim() || "Not provided"
        };
      });

      // Process players, preserving full names from availability sheet
      return playerRows.map(row => {
        const rawName = row.c[AVAILABILITY_COLS.NAME]?.v?.toString().trim() || "";
        const key = rawName.toLowerCase();

        return {
          name: rawName,
          contact: contactMap[key] || { phone: "Not found", email: "Not found", facebook: "Not found" },
          availability: {
            Mon: row.c[AVAILABILITY_COLS.MONDAY]?.v?.toString().trim() || "‚ùå Unavailable",
            Tue: row.c[AVAILABILITY_COLS.TUESDAY]?.v?.toString().trim() || "‚ùå Unavailable",
            Wed: row.c[AVAILABILITY_COLS.WEDNESDAY]?.v?.toString().trim() || "‚ùå Unavailable",
            Thu: row.c[AVAILABILITY_COLS.THURSDAY]?.v?.toString().trim() || "‚ùå Unavailable",
            Fri: row.c[AVAILABILITY_COLS.FRIDAY]?.v?.toString().trim() || "‚ùå Unavailable",
            Sat: row.c[AVAILABILITY_COLS.SATURDAY]?.v?.toString().trim() || "‚ùå Unavailable",
          },
          location: row.c[AVAILABILITY_COLS.LOCATION]?.v?.toString().trim() || "No preferred location"
        };
      }).filter(p => p.name);
    } catch (e) {
      console.error("Error fetching players:", e);
      return [];
    }
  }

  function renderPlayers(players) {
    const container = document.getElementById("results");
    if (!players.length) {
      container.innerHTML = "<p>No players found</p>";
      return;
    }
    container.innerHTML = players.map(player => `
      <div class="player">
        <h3>${player.name}</h3>
        <p>üìû Phone: ${player.contact.phone}</p>
        <p>üìß Email: ${player.contact.email}</p>
        <p>üîµ Facebook: ${player.contact.facebook}</p>
        <p>üìç Location:<br>${player.location.split('\n').map(l => l.trim()).join('<br>')}</p>
        <div class="availability-grid">
          ${Object.entries(player.availability).map(([day, time]) => `
            <div class="availability-day">
              <strong>${day}</strong>
              <div class="available-slot">${time}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join("");
  }

  async function initSearch() {
    allPlayers = await fetchPlayers();
    console.log("Loaded players:", allPlayers);
    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      const filtered = allPlayers.filter(p =>
        p.name.toLowerCase().includes(term) ||
        Object.values(p.availability).some(time => time.toLowerCase().includes(term)) ||
        p.location.toLowerCase().includes(term)
      );
      renderPlayers(filtered);
    });
  }

  window.verifyPin = verifyPin;
})();
</script>

</body>
</html>
