<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Search Portal</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    #searchSection { display: none; }
    input, button { padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; }
    button { background: #1976d2; color: white; border: none; cursor: pointer; border-radius: 4px; }
    #results { margin-top: 20px; }
    #pinSection { margin-bottom: 30px; }
    .player { background: #f9f9f9; border-radius: 8px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .player h3 { margin: 0 0 8px 0; color: #1976d2; }
    .player p { margin: 5px 0; }
    .availability-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; margin-top: 10px; }
    .availability-day { padding: 8px; border-radius: 4px; background: #f0f7ff; border: 1px solid #d0e3ff; }
    .available-slot { margin-top: 5px; padding: 4px; background: #e6f7d9; border-radius: 3px; font-size: 0.9em; }
  </style>
</head>
<body>

<div id="pinSection">
  <h2>Player Search Portal</h2>
  <input type="password" id="pinInput" placeholder="Enter your PIN" />
  <button onclick="verifyPin()">Submit</button>
  <div id="pinMessage" style="color:red; margin-top:10px;"></div>
</div>

<div id="searchSection">
  <h2>Player Search</h2>
  <input type="text" id="searchInput" placeholder="Search players or availability..." />
  <div id="results"><p>Start typing to search players...</p></div>
</div>

<script>
(function() {
  const sheetID = "1tvMgMHsRwQxsR6lMNlSnztmwpK7fhZeNEyqjTqmRFRc";
  const pinSheetName = "BCAPL SIGNUP";
  const playerSheetName = "BCAPL Availability";
  const contactSheetName = "Contact Info";

  // Column indexes (0-based)
  const CONTACT_COLS = {
    NAME: 0,    // Column A
    PHONE: 1,   // Column B
    EMAIL: 2,   // Column C
    FACEBOOK: 3 // Column D
  };

  const AVAILABILITY_COLS = {
    NAME: 0,    // Column A
    MONDAY: 1,  // Column B
    TUESDAY: 2, // Column C
    WEDNESDAY: 3, // Column D
    THURSDAY: 4,  // Column E
    FRIDAY: 5,    // Column F
    SATURDAY: 6,  // Column G
    LOCATION: 7   // Column H
  };

  let allPlayers = [];

  async function verifyPin() {
    const pin = document.getElementById("pinInput").value.trim();
    if (!pin) {
      document.getElementById("pinMessage").innerText = "Please enter a PIN.";
      return;
    }
    document.getElementById("pinMessage").innerText = "Checking PIN...";

    try {
      const rows = await fetchSheetData(pinSheetName);
      const pinExists = rows.some(row => {
        const pinCol = row.c[11]; // Column L (index 11)
        return pinCol && pinCol.v && pinCol.v.toString() === pin;
      });

      if (pinExists) {
        document.getElementById("pinSection").style.display = "none";
        document.getElementById("searchSection").style.display = "block";
        initSearch();
      } else {
        document.getElementById("pinMessage").innerText = "Invalid PIN. Please try again.";
      }
    } catch (error) {
      console.error("Error:", error);
      document.getElementById("pinMessage").innerText = "Error verifying PIN. Please try again later.";
    }
  }

  async function fetchSheetData(sheetName) {
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
    const response = await fetch(url);
    const text = await response.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    return json.table.rows;
  }

  async function fetchPlayers() {
    try {
      const [playerRows, contactRows] = await Promise.all([
        fetchSheetData(playerSheetName),
        fetchSheetData(contactSheetName)
      ]);

      // Debug raw name data
      console.log("First 3 Availability Names:", 
        playerRows.slice(0, 3).map(row => row.c[AVAILABILITY_COLS.NAME]?.v));
      console.log("First 3 Contact Names:", 
        contactRows.slice(0, 3).map(row => row.c[CONTACT_COLS.NAME]?.v));

      // Build contact map with exact name matching
      const contactMap = {};
      contactRows.forEach(row => {
        const rawName = row.c[CONTACT_COLS.NAME]?.v?.toString().trim() || "";
        if (!rawName) return;

        // Use exact lowercase match but preserve original name
        contactMap[rawName.toLowerCase()] = {
          rawName: rawName, // Preserve original formatting
          phone: row.c[CONTACT_COLS.PHONE]?.v?.toString()
            .replace('Text Only: ', '')
            .trim() || "Not provided",
          email: row.c[CONTACT_COLS.EMAIL]?.v?.toString()
            .replace('Email: ', '')
            .trim() || "Not provided",
          facebook: row.c[CONTACT_COLS.FACEBOOK]?.v?.toString()
            .trim() || "Not provided"
        };
      });

      // Process players with strict name preservation
      return playerRows.map(row => {
        const rawName = row.c[AVAILABILITY_COLS.NAME]?.v?.toString().trim() || "";
        const normalizedName = rawName.toLowerCase();

        // Find exact match or closest partial match
        let contact = contactMap[normalizedName];
        if (!contact) {
          const partialMatch = Object.keys(contactMap).find(key => 
            normalizedName.includes(key) || key.includes(normalizedName)
          );
          contact = partialMatch ? contactMap[partialMatch] : null;
        }

        return {
          name: rawName, // Always use availability sheet's original name
          contact: contact || {
            phone: "Not found",
            email: "Not found",
            facebook: "Not found"
          },
          availability: {
            Mon: row.c[AVAILABILITY_COLS.MONDAY]?.v?.toString().trim() || "âŒ Unavailable",
            Tue: row.c[AVAILABILITY_COLS.TUESDAY]?.v?.toString().trim() || "âŒ Unavailable",
            Wed: row.c[AVAILABILITY_COLS.WEDNESDAY]?.v?.toString().trim() || "âŒ Unavailable",
            Thu: row.c[AVAILABILITY_COLS.THURSDAY]?.v?.toString().trim() || "âŒ Unavailable",
            Fri: row.c[AVAILABILITY_COLS.FRIDAY]?.v?.toString().trim() || "âŒ Unavailable",
            Sat: row.c[AVAILABILITY_COLS.SATURDAY]?.v?.toString().trim() || "âŒ Unavailable"
          },
          location: row.c[AVAILABILITY_COLS.LOCATION]?.v?.toString().trim() || "No preferred location"
        };
      }).filter(player => player.name);
    } catch (error) {
      console.error("Error:", error);
      return [];
    }
  }

  function renderPlayers(list) {
    const container = document.getElementById("results");
    container.innerHTML = list.length ? list.map(player => `
      <div class="player">
        <h3>${player.name}</h3>
        <p>ðŸ“ž Phone: ${player.contact.phone}</p>
        <p>ðŸ“§ Email: ${player.contact.email}</p>
        <p>ðŸ”µ Facebook: ${player.contact.facebook}</p>
        <p>ðŸ“ Location: ${player.location.split('\n').map(loc => loc.trim()).join('<br>')}</p>
        <div class="availability-grid">
          ${Object.entries(player.availability).map(([day, time]) => `
            <div class="availability-day">
              <strong>${day}</strong>
              <div class="available-slot">${time}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join("") : "<p>No players found</p>";
  }

  async function initSearch() {
    allPlayers = await fetchPlayers();
    console.log("Processed Players:", allPlayers);
    
    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      const filtered = allPlayers.filter(p => 
        p.name.toLowerCase().includes(term) || 
        Object.values(p.availability).some(time => time.toLowerCase().includes(term)) ||
        p.location.toLowerCase().includes(term)
      );
      renderPlayers(filtered);
    });
  }

  window.verifyPin = verifyPin;
})();
</script>
</body>
</html>
